<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu·∫£n L√Ω L√¨ X√¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f5f5f5; padding: 20px; }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #FFD700;
            padding-bottom: 15px;
        }
        .sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #FFD700;
        }
        .section h2 { color: #333; margin-bottom: 15px; font-size: 1.3em; }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #e74c3c; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #333; font-weight: bold; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ddd;
            border-radius: 5px; font-size: 1em;
        }
        input:focus, select:focus {
            outline: none; border-color: #FFD700;
            box-shadow: 0 0 5px rgba(255,215,0,0.3);
        }
        button {
            background: #FFD700; color: #333; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: bold; transition: all 0.3s;
            margin-right: 10px; margin-bottom: 10px;
        }
        button:hover {
            background: #FFA500; transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        button.danger { background: #e74c3c; color: white; }
        button.danger:hover { background: #c0392b; }
        button.success { background: #27ae60; color: white; }
        button.success:hover { background: #229954; }
        table {
            width: 100%; border-collapse: collapse; margin-top: 15px;
        }
        table th {
            background: #333; color: #FFD700; padding: 12px; text-align: left;
        }
        table td { padding: 12px; border-bottom: 1px solid #ddd; }
        table tr:hover { background: #f9f9f9; }
        table tr:last-child td { border-bottom: none; }
        .delete-btn {
            background: #e74c3c; color: white; padding: 5px 10px;
            border: none; border-radius: 3px; cursor: pointer; font-size: 0.9em;
        }
        .delete-btn:hover { background: #c0392b; }
        .history-section { grid-column: 1 / -1; }
        .empty-message {
            text-align: center; color: #999; padding: 20px; font-style: italic;
        }
        .btn-group { display: flex; gap: 10px; }
        @media (max-width: 768px) {
            .sections { grid-template-columns: 1fr; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <body onload="checkPassword()">
    <div class="admin-container">
        <h1>üìä QU·∫¢N L√ù L√å X√å</h1>
        
        <div class="sections">
            <div class="section">
                <h2>üìà Th·ªëng K√™</h2>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-label">T·ªïng L·∫ßn L·∫Øc</div>
                        <div class="stat-value" id="totalShakes">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">T·ªïng Ti·ªÅn Ph√°t</div>
                        <div class="stat-value" id="totalAmount">0 VNƒê</div>
                    </div>
                </div>
                <button class="danger" onclick="resetAllData()">üóëÔ∏è X√≥a T·∫•t C·∫£ D·ªØ Li·ªáu</button>
            </div>
            
            <div class="section">
                <h2>üí∞ Th√™m M·ªánh Gi√° M·ªõi</h2>
                <div class="form-group">
                    <label>M·ªánh gi√° (VNƒê):</label>
                    <input type="number" id="newAmount" placeholder="Nh·∫≠p s·ªë ti·ªÅn" min="0">
                </div>
                <div class="form-group">
                    <label>T·ªâ L·ªá (%):</label>
                    <input type="number" id="newPercentage" placeholder="Nh·∫≠p t·ªâ l·ªá %" min="0" max="100" value="10">
                </div>
                <button class="success" onclick="addPrize()">‚ûï Th√™m M·ªánh Gi√°</button>
                <button class="danger" onclick="clearAllPrizes()" style="margin-left: 10px;">üóëÔ∏è X√≥a T·∫•t C·∫£</button>
            </div>
            
            <div class="section">
                <h2>üíé Danh S√°ch M·ªánh Gi√° & T·ªâ L·ªá</h2>
                <table id="prizeTable">
                    <thead>
                        <tr>
                            <th>M·ªánh Gi√°</th>
                            <th>T·ªâ L·ªá (%)</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="prizeTableBody">
                        <tr><td colspan="3" class="empty-message">Ch∆∞a c√≥ m·ªánh gi√° n√†o</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section history-section">
                <h2>üìù L·ªãch S·ª≠ L·∫Øc L√¨ X√¨</h2>
                <table id="historyTable">
                    <thead>
                        <tr>
                            <th>T√™n Ng∆∞·ªùi L·∫Øc</th>
                            <th>Th·ªùi Gian</th>
                            <th>M·ªánh Gi√°</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="4" class="empty-message">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section history-section">
                <h2>üë• Th·ªëng K√™ Ng∆∞·ªùi Ch∆°i</h2>
                <table id="playerStatsTable">
                    <thead>
                        <tr>
                            <th>T√™n Ng∆∞·ªùi Ch∆°i</th>
                            <th>S·ªë L·∫ßn L·∫Øc</th>
                            <th>T·ªïng Ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="playerStatsBody">
                        <tr><td colspan="3" class="empty-message">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASS = "tuan2006";

function checkPassword() {
    const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u admin:");
    if (pass !== ADMIN_PASS) {
        alert("Sai m·∫≠t kh·∫©u!");
        window.location.href = "lixi.html";
    }
}
        function loadPrizes() {
            const saved = localStorage.getItem('prizesList');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (typeof parsed === 'object' && !Array.isArray(parsed)) {
                        return parsed;
                    }
                } catch (e) {
                    console.log('S·ª≠ d·ª•ng m·ªánh gi√° m·∫∑c ƒë·ªãnh');
                }
            }
            return {
                '1000': 30,
                '2000': 15,
                '5000': 15,
                '10000': 10,
                '20000': 10,
                '50000': 10,
                '100000': 2,
                '200000': 2,
                '500000': 1
            };
        }

        function loadHistory() {
            const saved = localStorage.getItem('lixiHistory');
            return saved ? JSON.parse(saved) : [];
        }

        function saveHistory(history) {
            localStorage.setItem('lixiHistory', JSON.stringify(history));
        }

        function updateStats() {
            const history = loadHistory();
            const totalShakes = history.length;
            let totalAmount = 0;
            history.forEach(entry => {
                const amount = parseInt(entry.amount.replace(/\D/g, '')) || 0;
                totalAmount += amount;
            });
            document.getElementById('totalShakes').textContent = totalShakes;
            document.getElementById('totalAmount').textContent =
                totalAmount.toLocaleString() + ' VNƒê';
        }

        function displayPrizes() {
            const prizes = loadPrizes();
            const tbody = document.getElementById('prizeTableBody');
            tbody.innerHTML = '';

            if (Object.keys(prizes).length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="3" class="empty-message">Ch∆∞a c√≥ m·ªánh gi√° n√†o</td></tr>';
                return;
            }

            const sortedPrizes = Object.entries(prizes)
                .sort((a, b) => parseInt(b[0]) - parseInt(a[0]));

            sortedPrizes.forEach(([amount, percentage]) => {
                const formattedAmount = parseInt(amount).toLocaleString();
                tbody.innerHTML += `
                    <tr>
                        <td>${formattedAmount} VNƒê</td>
                        <td>
                            <input type="number" min="0" max="100" value="${percentage}"
                                   onchange="updatePrizePercentage('${amount}', this.value)"
                                   style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">%
                        </td>
                        <td><button class="delete-btn" onclick="removePrize('${amount}')">X√≥a</button></td>
                    </tr>
                `;
            });
        }

        function displayHistory() {
            const history = loadHistory();
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (history.length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="4" class="empty-message">Ch∆∞a c√≥ l·ªãch s·ª≠</td></tr>';
                return;
            }

            history.slice().reverse().forEach((entry, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${entry.playerName || '·∫®n danh'}</strong></td>
                        <td>${entry.time}</td>
                        <td>${entry.amount}</td>
                        <td>
                            <button class="delete-btn"
                                onclick="deleteHistoryEntry(${history.length - 1 - index})">
                                X√≥a
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function displayPlayerStats() {
            const history = loadHistory();
            const playerStats = {};

            history.forEach(entry => {
                const name = entry.playerName || '·∫®n danh';
                const amount = parseInt(entry.amount.replace(/\D/g, '')) || 0;

                if (!playerStats[name]) {
                    playerStats[name] = { count: 0, total: 0 };
                }
                playerStats[name].count += 1;
                playerStats[name].total += amount;
            });

            const tbody = document.getElementById('playerStatsBody');
            tbody.innerHTML = '';

            if (Object.keys(playerStats).length === 0) {
                tbody.innerHTML =
                    '<tr><td colspan="3" class="empty-message">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            const sortedPlayers = Object.entries(playerStats)
                .sort((a, b) => b[1].total - a[1].total);

            sortedPlayers.forEach(([name, stats]) => {
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${name}</strong></td>
                        <td style="text-align: center;">${stats.count} l·∫ßn</td>
                        <td style="text-align: right; color: #27ae60; font-weight: bold;">
                            ${stats.total.toLocaleString()} VNƒê
                        </td>
                    </tr>
                `;
            });
        }

        function addPrize() {
            const amount = parseInt(document.getElementById('newAmount').value);
            const percentage = parseInt(document.getElementById('newPercentage').value);

            if (!amount || amount <= 0) {
                alert('Vui l√≤ng nh·∫≠p m·ªánh gi√° h·ª£p l·ªá!');
                return;
            }
            if (!percentage || percentage <= 0) {
                alert('Vui l√≤ng nh·∫≠p t·ªâ l·ªá h·ª£p l·ªá!');
                return;
            }

            const prizes = loadPrizes();
            prizes[amount.toString()] = percentage;

            localStorage.setItem('prizesList', JSON.stringify(prizes));
            document.getElementById('newAmount').value = '';
            document.getElementById('newPercentage').value = '10';

            displayPrizes();
            try { socket.emit('update-prizes', prizes); } catch (e) {}
            alert('ƒê√£ th√™m m·ªánh gi√° ' + amount.toLocaleString() + ' VNƒê v·ªõi t·ªâ l·ªá ' + percentage + '%');
        }

        function updatePrizePercentage(amount, percentage) {
            const prizes = loadPrizes();
            const pct = parseInt(percentage);

            if (pct < 0) {
                alert('T·ªâ l·ªá kh√¥ng ƒë∆∞·ª£c √¢m!');
                displayPrizes();
                return;
            }

            prizes[amount] = pct;
            localStorage.setItem('prizesList', JSON.stringify(prizes));
            try { socket.emit('update-prizes', prizes); } catch (e) {}
            alert('ƒê√£ c·∫≠p nh·∫≠t t·ªâ l·ªá th√†nh ' + pct + '%');
            displayPrizes();
        }

        function removePrize(amount) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a m·ªánh gi√° n√†y?')) return;

            const prizes = loadPrizes();
            delete prizes[amount];
            localStorage.setItem('prizesList', JSON.stringify(prizes));
            displayPrizes();
            try { socket.emit('update-prizes', prizes); } catch (e) {}
        }

        function clearAllPrizes() {
            if (!confirm('‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA T·∫§T C·∫¢ M·ªÜNH GI√Å?')) return;
            if (!confirm('X√°c nh·∫≠n l·∫ßn n·ªØa - s·∫Ω x√≥a t·∫•t c·∫£!')) return;

            localStorage.setItem('prizesList', JSON.stringify({}));
            displayPrizes();
            try { socket.emit('update-prizes', {}); } catch (e) {}
            alert('‚úì ƒê√£ x√≥a t·∫•t c·∫£ m·ªánh gi√°. B·∫°n c√≥ th·ªÉ nh·∫≠p l·∫°i!');
        }

        function deleteHistoryEntry(index) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a entry n√†y?')) return;

            const history = loadHistory();
            history.splice(index, 1);
            saveHistory(history);
            updateStats();
            displayHistory();
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è B·∫†N C√ì CH·∫ÆC MU·ªêN X√ìA T·∫§T C·∫¢ D·ªÆ LI·ªÜU? H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ HO√ÄN T√ÅC!')) return;
            if (!confirm('C·∫¢NH B√ÅO: B·∫°n s·∫Øp x√≥a t·∫•t c·∫£ l·ªãch s·ª≠ l·∫Øc. Ti·∫øp t·ª•c kh√¥ng?')) return;

            localStorage.removeItem('lixiHistory');
            updateStats();
            displayHistory();
            displayPlayerStats();
            alert('‚úì ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu l·ªãch s·ª≠');
        }

        function init() {
            displayPrizes();
            displayHistory();
            displayPlayerStats();
            updateStats();
        }

        init();

        setInterval(() => {
            updateStats();
            displayPlayerStats();
            displayHistory();
        }, 2000);
    </script>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = { emit(){}, on(){} };

        try {
            if (typeof io !== 'undefined') {
                socket = io();
                socket.emit('register-admin');
            }
        } catch (e) {
            console.warn('Socket.io kh√¥ng kh·∫£ d·ª•ng, admin ch·∫°y offline');
        }

        socket.on('new-shake', entry => {
            try {
                const history = loadHistory();
                history.push(entry);
                saveHistory(history);
            } catch (e) {}
            updateStats();
            displayHistory();
            displayPlayerStats();
        });
    </script>
</body>
</html>



